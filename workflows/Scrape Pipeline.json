{
  "id": "scrape-pipeline-workflow",
  "name": "Scrape Pipeline",
  "nodes": [
    {
      "parameters": {
        "content": "## Scrape Pipeline (Orchestrator)\n\n**Zweck:** Koordiniert alle Scraper und verarbeitet Artikel.\n\n### Ablauf\n```\nTrigger\n   â”‚\n   â”œâ”€â”€â–º Google News Scraper (parallel)\n   â”‚           â”‚\n   â”œâ”€â”€â–º RSS Feeds Scraper (parallel)\n   â”‚           â”‚\n   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â–º Merge All\n                       â”‚\n                       â–¼\n               Daten vorhanden?\n                       â”‚\n                       â–¼\n               Normalize + Analyze\n                    (GPT-4o-mini)\n                       â”‚\n                       â–¼\n                   DB Insert\n                 (19 Spalten)\n```\n\n### Trigger\n- â° Schedule: Alle 15 Min\n- ðŸ”— Webhook: POST /scrape-pipeline\n\n### Sub-Workflows\n- SCRAPER: Google News\n- SCRAPER: RSS Feeds\n- Normalize Articles\n\n### DB Tabelle\n`articles` - Alle normalisierten Artikel",
        "height": 560,
        "width": 320
      },
      "id": "info-note",
      "name": "Info",
      "type": "n8n-nodes-base.stickyNote",
      "typeVersion": 1,
      "position": [
        -560,
        -50
      ]
    },
    {
      "parameters": {
        "rule": {
          "interval": [
            {
              "field": "minutes",
              "minutesInterval": 15
            }
          ]
        }
      },
      "id": "7621e647-d5a1-4629-8273-67f7173ce689",
      "name": "Every 15 Minutes",
      "type": "n8n-nodes-base.scheduleTrigger",
      "typeVersion": 1.1,
      "position": [
        -288,
        192
      ]
    },
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "scrape-pipeline",
        "options": {}
      },
      "id": "f4e0a0c5-7550-46d8-8014-025e1dd433d8",
      "name": "Webhook",
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 1.1,
      "position": [
        -288,
        384
      ],
      "webhookId": "scrape-pipeline-webhook"
    },
    {
      "parameters": {
        "workflowId": {
          "__rl": true,
          "value": "TAwPcGi3EepKcWth",
          "mode": "list",
          "cachedResultUrl": "/workflow/TAwPcGi3EepKcWth",
          "cachedResultName": "SCRAPER: Google News"
        },
        "workflowInputs": {
          "mappingMode": "defineBelow",
          "value": {},
          "matchingColumns": [],
          "schema": [],
          "attemptToConvertTypes": false,
          "convertFieldsToString": true
        },
        "options": {}
      },
      "id": "faf76326-c4b9-4711-81af-5e3ee75eab1c",
      "name": "Call Google News Scraper",
      "type": "n8n-nodes-base.executeWorkflow",
      "typeVersion": 1.3,
      "position": [
        0,
        0
      ],
      "continueOnFail": true
    },
    {
      "parameters": {
        "workflowId": {
          "__rl": true,
          "value": "jBs4v5XzeetXiWlr",
          "mode": "list",
          "cachedResultUrl": "/workflow/jBs4v5XzeetXiWlr",
          "cachedResultName": "SCRAPER: RSS Feeds"
        },
        "workflowInputs": {
          "mappingMode": "defineBelow",
          "value": {},
          "matchingColumns": [],
          "schema": [],
          "attemptToConvertTypes": false,
          "convertFieldsToString": true
        },
        "options": {}
      },
      "id": "d55c0bf5-60dc-4d5a-b9f6-f659df2febaf",
      "name": "Call RSS Feeds Scraper",
      "type": "n8n-nodes-base.executeWorkflow",
      "typeVersion": 1.3,
      "position": [
        0,
        224
      ],
      "continueOnFail": true
    },
    {
      "parameters": {
        "jsCode": "const allItems = $input.all();\nconst merged = [];\n\nfor (const item of allItems) {\n  const d = item.json;\n  if (!d || Object.keys(d).length === 0) continue;\n  if (d.error) continue;\n  merged.push({ json: d });\n}\n\nif (merged.length === 0) {\n  return [{ json: { _empty: true, message: 'Keine Daten von Scrapern' } }];\n}\n\nreturn merged;"
      },
      "id": "c0051cb8-5224-49d7-924d-3ac9db6c19df",
      "name": "Merge All",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        272,
        224
      ]
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "loose"
          },
          "conditions": [
            {
              "id": "has-url",
              "leftValue": "={{ $json.url }}",
              "rightValue": "",
              "operator": {
                "type": "string",
                "operation": "notEmpty"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "id": "6d97ab1f-70ae-4776-8094-1341de3a8bba",
      "name": "Daten vorhanden?",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2,
      "position": [
        480,
        224
      ]
    },
    {
      "parameters": {
        "workflowId": {
          "__rl": true,
          "value": "6AGSjWYEJDPHqgvJ",
          "mode": "list",
          "cachedResultUrl": "/workflow/6AGSjWYEJDPHqgvJ",
          "cachedResultName": "Normalize Articles"
        },
        "workflowInputs": {
          "mappingMode": "defineBelow",
          "value": {
            "raw_articles": "={{ JSON.stringify($input.all().map(i => i.json)) }}",
            "filters": ""
          },
          "matchingColumns": [
            "raw_articles"
          ],
          "schema": [
            {
              "id": "raw_articles",
              "displayName": "raw_articles",
              "required": true,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string"
            },
            {
              "id": "filters",
              "displayName": "filters",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string"
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": true
        },
        "options": {}
      },
      "id": "8a6c1cae-976e-4eeb-ab67-fa80c5eda04b",
      "name": "Normalize + Analyze",
      "type": "n8n-nodes-base.executeWorkflow",
      "typeVersion": 1.3,
      "position": [
        720,
        144
      ]
    },
    {
      "parameters": {
        "jsCode": "// Pre-format arrays for PostgreSQL insertion\nconst items = $input.all();\n\nreturn items.map(item => {\n  const d = item.json;\n  \n  // Helper to format array for PostgreSQL\n  const formatArray = (arr) => {\n    if (!arr || !Array.isArray(arr) || arr.length === 0) return '{}';\n    // Escape quotes and format as PostgreSQL array\n    const escaped = arr.map(v => String(v).replace(/\"/g, '\\\\\"'));\n    return '{\"' + escaped.join('\",\"') + '\"}';\n  };\n  \n  return {\n    json: {\n      url: d.url || '',\n      title: d.title || '',\n      content: d.content || '',\n      source: d.source || '',\n      source_type: d.source_type || '',\n      published_at: d.published_at || null,\n      summary: d.summary || '',\n      sentiment: d.sentiment || '',\n      sentiment_score: d.sentiment_score || null,\n      priority: d.priority || '',\n      priority_reason: d.priority_reason || '',\n      topics: formatArray(d.topics),\n      keywords: formatArray(d.keywords),\n      companies: formatArray(d.companies),\n      persons: formatArray(d.persons),\n      regions: formatArray(d.regions),\n      language: d.language || 'de',\n      category: d.category || 'general',\n      relevance_match: formatArray(d.relevance_match)\n    }\n  };\n});"
      },
      "id": "prepare-for-db",
      "name": "Prepare for DB",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        960,
        144
      ]
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "INSERT INTO articles (url, title, content, source, source_type, published_at, summary, sentiment, sentiment_score, priority, priority_reason, topics, keywords, companies, persons, regions, language, category, relevance_match, processed, sent) VALUES ($1, $2, $3, $4, $5, $6, $7, $8, $9, $10, $11, $12, $13, $14, $15, $16, $17, $18, $19, TRUE, FALSE) ON CONFLICT (url) DO NOTHING",
        "options": {
          "queryReplacement": "={{ $json.url }},={{ $json.title }},={{ $json.content }},={{ $json.source }},={{ $json.source_type }},={{ $json.published_at }},={{ $json.summary }},={{ $json.sentiment }},={{ $json.sentiment_score }},={{ $json.priority }},={{ $json.priority_reason }},={{ $json.topics }},={{ $json.keywords }},={{ $json.companies }},={{ $json.persons }},={{ $json.regions }},={{ $json.language }},={{ $json.category }},={{ $json.relevance_match }}"
        }
      },
      "id": "5873d7a4-d021-4b73-8907-330715d40130",
      "name": "DB Insert",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.4,
      "position": [
        1200,
        144
      ],
      "credentials": {
        "postgres": {
          "id": "news-agent-postgres",
          "name": "News Agent DB"
        }
      },
      "continueOnFail": true
    },
    {
      "parameters": {
        "jsCode": "const items = $input.all();\nconst total = items.length;\nconst dupes = items.filter(i => i.json.affectedRows === 0).length;\nconst failed = items.filter(i => i.json.error).length;\nconst inserted = total - dupes - failed;\n\nreturn [{\n  json: {\n    timestamp: new Date().toISOString(),\n    total,\n    inserted,\n    duplicates: dupes,\n    failed,\n    message: `${inserted} neu, ${dupes} Duplikate, ${failed} Fehler`\n  }\n}];"
      },
      "id": "e84f9b98-596e-4d87-8718-3586e085450e",
      "name": "Ergebnis",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1440,
        144
      ]
    }
  ],
  "pinData": {},
  "connections": {
    "Every 15 Minutes": {
      "main": [
        [
          {
            "node": "Call Google News Scraper",
            "type": "main",
            "index": 0
          },
          {
            "node": "Call RSS Feeds Scraper",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Webhook": {
      "main": [
        [
          {
            "node": "Call Google News Scraper",
            "type": "main",
            "index": 0
          },
          {
            "node": "Call RSS Feeds Scraper",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Call Google News Scraper": {
      "main": [
        [
          {
            "node": "Merge All",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Call RSS Feeds Scraper": {
      "main": [
        [
          {
            "node": "Merge All",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Merge All": {
      "main": [
        [
          {
            "node": "Daten vorhanden?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Daten vorhanden?": {
      "main": [
        [
          {
            "node": "Normalize + Analyze",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Normalize + Analyze": {
      "main": [
        [
          {
            "node": "Prepare for DB",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Prepare for DB": {
      "main": [
        [
          {
            "node": "DB Insert",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "DB Insert": {
      "main": [
        [
          {
            "node": "Ergebnis",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "active": false,
  "settings": {
    "executionOrder": "v1",
    "binaryMode": "separate",
    "availableInMCP": false
  },
  "versionId": "5322130b-fa8f-41ea-bc29-13ae7fb00db2",
  "meta": {
    "instanceId": "2c9038e79e4f0de69b3e8f277105c48d1cdaae248cdaf2f5ca828ee1f7eccc63"
  },
  "id": "ba9OG35bDKJwzfPb",
  "tags": []
}